-- 1. Find invalid order items with 0 or negative quantity.
SELECT oi.order_item_id,
       oi.order_id,
       oi.product_id,
       oi.quantity,
       oi.discount_applied
FROM order_items oi
WHERE oi.quantity <= 0


-- 2. Calculate percentage of cancelled orders per month.
WITH monthly_counts AS (
  SELECT DATE_TRUNC('month', order_date) AS month,
         COUNT(*)                                   AS total_orders,
         SUM(CASE WHEN shipping_status='Cancelled' THEN 1 ELSE 0 END) AS cancelled_cnt
  FROM orders
  WHERE order_date >= '2023-01-01' AND order_date < '2024-01-01'
  GROUP BY 1
)
SELECT TO_CHAR(month, 'YYYY MM') AS month,
       total_orders,
       cancelled_cnt,
       ROUND( cancelled_cnt::numeric / total_orders * 100 , 2) AS pct_cancelled
FROM monthly_counts
ORDER BY 1


-- 3. Find duplicate email addresses in the customers table.
SELECT email,
       COUNT(*) AS occurrences,
       ARRAY_AGG(customer_id ORDER BY customer_id) AS customer_ids
FROM customers
WHERE email IS NOT NULL
GROUP BY email
HAVING COUNT(*) > 1
ORDER BY occurrences DESC


